# Аналитика по разграничению доступа к темам

## 1. Контекст и новые требования

- При создании темы необходимо сразу получать список соавторов (frontend уже отправляет данные из `app/pages/topics/create.vue`).
- Доступ к теме (просмотр, редактирование, управление подразделами/вопросами/тестами) должны иметь только:
  - автор темы (`creator_id`);
  - соавторы, добавленные при создании или позже;
  - администраторы (полный доступ ко всем темам).
- Текущая реализация допускает доступ для любого преподавателя, что нужно убрать.
- Требуется продумать универсальный механизм проверки прав, который можно переиспользовать в существующих эндпоинтах (`topics`, `sections`, `subsections`, `tests`, `question_bank` и др.).
- Нужно подготовить миграцию, чтобы существующие темы получили корректные связи с авторами/соавторами.

## 2. Текущее состояние бекенда

### 2.1 Доменные модели и связи

- Сущность `Topic` хранит `creator_id`, связан. с разделами, тестами и таблицей авторов.

```167:205:Backend/src/domain/models.py
class Topic(Base):
    id = Column(Integer, primary_key=True, autoincrement=True)
    title = Column(String, nullable=False)
    ...
    creator_id = Column(Integer, ForeignKey("users.id"), nullable=True, index=True)
    ...
    authors = relationship(
        "TopicAuthor",
        back_populates="topic",
        cascade="all, delete-orphan",
    )
```

- Таблица `topic_authors` уже существует и хранит пары (topic_id, user_id), а также `added_by`.

```381:400:Backend/src/domain/models.py
class TopicAuthor(Base):
    topic_id = Column(Integer, ForeignKey("topics.id"), primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), primary_key=True, index=True)
    added_by = Column(Integer, ForeignKey("users.id"), nullable=False)
    created_at = Column(DateTime, default=datetime.now)
    is_archived = Column(Boolean, default=False)
```

### 2.2 Сервис и репозиторий тем

- Создание темы не принимает список соавторов и не записывает автора в `topic_authors`.
- Список и получение тем основаны на роли: админ/преподаватель видят всё, студенты — только назначенные темы.

```617:744:Backend/src/service/topics.py
async def list_topics_service(..., user_role: str, ...):
    topics = await list_topics(..., user_id=user_id, user_role=user_role)
    ...
```

- Репозиторий `list_topics` фильтрует только студентов, остальные роли получают все темы без ограничений.

```188:263:Backend/src/repository/topic.py
async def list_topics(..., user_role: Optional[str] = None):
    if user_role == "student":
        ...
    else:
        # администраторы и преподаватели видят все темы
        stmt = select(Topic)
```

### 2.3 Текущие проверки доступа

- Большинство эндпоинтов по темам/разделам/подразделам используют только зависимость `admin_or_teacher`.
- Утилита `ensure_can_access_topic` уже реализована в `src/service/topic_authors.py` и применяется в подсистеме банка вопросов, но не в остальных API.
- Вопросы, разделы, подразделы и тесты не проверяют принадлежность пользователя к теме.
- Существуют «старые» роуты (`routes_old.py`) параллельно с новыми модульными маршрутами; при обновлении нужно учитывать оба варианта или окончательно перевести потребителей на новые роуты.

### 2.4 Работа с авторами

- В API банка вопросов (`/question-bank/topics/{topic_id}/authors`) уже есть CRUD авторов и используется `ensure_can_manage_authors/ensure_can_access_topic`.
- При создании темы не происходит автоматическое добавление создателя в таблицу авторов — доступ обеспечивается только через `creator_id`.
- Миграций, заполняющих `topic_authors` для существующих тем, нет.

## 3. Основные разрывы относительно новых требований

1. **Создание темы** — отсутствует поле для передачи соавторов и логика сохранения их в `topic_authors`. Создатель должен фиксироваться автоматически и не подлежит изменению.
2. **Единый доступ** — эндпоинты полагаются на роль `admin_or_teacher`, без проверки конкретной темы.
3. **Чтение тем** — преподаватели видят все темы; необходимо ограничить списки и детализацию только темами, где пользователь является создателем или активным соавтором. Для остальных тем нужно возвращать только метаданные с запретом на действия (через вспомогательные флаги).
4. **Связанные сущности** — операции с разделами, подразделами, тестами, вопросами должны проверять доступ через родительскую тему с учётом создателя и соавторов.
5. **Миграция** — требуется заполнить `topic_authors` (минимум — добавить создателя как автора) и обеспечить корректность данных, чтобы фильтрация по создателю/соавторам не ломала существующие сценарии. Массово добавлять «старых» преподавателей не нужно — лишние связи будут удалены вручную.
6. **Схемы** — Pydantic-схемы `TopicCreateSchema`, `TopicUpdateSchema`, `TopicReadSchema` не описывают авторов/соавторов и не возвращают флаги для UI.
7. **Логи** — текущее логирование на английском; для новых изменений нужно соблюдать политику русификации и использовать согласованную формулировку ошибки («У вас нет доступа: вы не являетесь создателем или соавтором темы»).

## 4. Предварительная концепция решения

### 4.1 Поток создания/обновления

- Расширить `TopicCreateSchema`, добавив список идентификаторов соавторов.
- В `create_topic_service`:
  - создавать тему и автоматически фиксировать создателя (`creator_id`) без возможности его изменения;
  - создавать (если отсутствует) запись в `topic_authors` для создателя;
  - валидировать переданный список соавторов и добавлять записи в `topic_authors`, игнорируя дубликаты и архивы.
- В `TopicUpdateSchema` предусмотреть управление только соавторами (создатель неизменяем).
- Добавить сервис синхронизации списка соавторов (добавление/удаление/архивирование) с русифицированными логами.

### 4.2 Универсальный доступ

- Реализовать/расширить зависимость FastAPI (например, `require_topic_permission`) с параметрами:
  - `topic_param` — имя аргумента с `topic_id` (или путь получения через связанные сущности);
  - `allow_admin=True` — администраторы проходят без проверки;
  - `enforce_edit=True/False` — при необходимости разделять чтение и редактирование (по умолчанию одинаковые права для создателя и соавторов).
- Зависимость использует `ensure_can_access_topic` или расширенный сервис, который:
  - проверяет роль пользователя;
  - подтверждает, что он создатель или активный соавтор (`topic_authors.is_archived=False`).
- Для сущностей без `topic_id` извлекать его из родительских объектов (`Section`, `Subsection`, `Test`, вопросы тестов и банка вопросов).
- Навесить зависимость на все ручки, напрямую связанные с темой и её содержимым (темы, разделы, подразделы, тесты, управление файлами темы и т.д.). Отдельно предусмотреть исключения для агрегированных отчётов/статистики — статистика остаётся доступной всем преподавателям (без права модификации).

### 4.3 Изменения в списках тем

- В `repository/topic.list_topics` применить фильтр:
  - админ — без ограничений;
  - преподаватель — `Topic.creator_id == user_id` или наличие активной записи в `topic_authors`;
  - преподаватель, привязанный к группе, но не являющийся соавтором — получает только базовые данные темы с флагами `can_manage=False`, `can_detach=False`;
  - студент — текущая логика по группам.
- Аналогичные проверки встроить в `get_topic_service` и связанные сервисы, чтобы:
  - при прямом запросе темы «чужой» преподаватель получал 403 на операции редактирования/просмотра контента;
  - агрегированные отчёты/статистику он по-прежнему видел (независимо от статуса соавтора).
- В эндпоинте `GET /api/v1/groups/management/{group_id}` расширить структуру `topics` — добавлять флаги `can_manage_topic`, `can_unlink_topic` в зависимости от статуса пользователя. Компонент `GroupAssignTopics.vue` должен отображать только темы, доступные создателю и соавторам (остальные скрываем или помечаем как недоступные).

### 4.4 Миграция данных

- Создать alembic-миграцию, которая:
  - для каждой темы добавляет в `topic_authors` запись с `user_id = creator_id`, `added_by = creator_id`, `is_archived = False`, если такой строки ещё нет;
  - при необходимости добавляет индексы/ограничения, усиливающие уникальность записей;
  - обеспечивает совместимость с дальнейшей фильтрацией.
- После миграции все запросы к таблице авторов будут учитывать создателя как явного участника.

### 4.5 API и схемы

- Добавить чтение авторов в ответ (`TopicReadSchema`), чтобы фронт мог отобразить текущий состав.
- Убедиться, что фронтенд и swagger-документация обновлены.

### 4.6 Тестирование

- Обновить/написать тесты для:
  - создания темы с соавторами;
  - проверки, что не-автор/не-админ не может получить или изменить тему/раздел/подраздел/тест;
  - миграции (как минимум smoke-тест или фикстуры).

## 5. Потенциальные зоны влияния

- `src/api/v1/topics` (CRUD, management, старые маршруты).
- `src/api/v1/sections`, `src/api/v1/subsections`, `src/api/v1/tests` (включая вложенные роуты).
- `src/api/v1/question_bank` (проверки уже есть — проверить совместимость).
- Сервисные слои: `service/topics.py`, `service/sections.py`, `service/subsections.py`, `service/tests.py`.
- Репозитории: `repository/topic.py`, `repository/sections`, `repository/subsections`, `repository/tests`.
- Безопасность: `security/security.py` (возможное расширение) + новый модуль с проверками по теме.

## 6. Открытые вопросы к постановке

1. **Создатель темы**: нужно ли всегда добавлять его в `topic_authors`, или достаточно `creator_id`?
2. **Политика по умолчанию**: что делать с уже существующими темами? Должны ли все преподаватели потерять доступ, кроме явных авторов, или потребуется массово назначить их соавторами?
3. **Управление соавторами**: используем ли существующие ручки `/question-bank/.../authors` для тем или добавляем новые на `/topics`?
4. **Видимость тем на фронте**: если преподаватель закреплён за группой с темой, но не является соавтором, должен ли он видеть тему?
5. **Архивирование соавторов**: оставляем ли подход с `is_archived`, или нужно физически удалять записи?
6. **Разделение прав**: нужно ли отличать доступ на чтение и редактирование для соавторов?
7. **Дополнительные ручки**: подтверждаем ли список «белых» эндпоинтов, которые должны оставаться без ограничений (например, отчёты, экспорт статистики)?
8. **Локализация**: финализируем ли сообщение «У вас нет доступа: вы не являетесь создателем или соавтором темы» и формат логов на русском?

## 7. Дополнительные вопросы для анализа

1. Как отслеживать и средствами UI подсвечивать темы, где преподаватель видит их только через группу (нет прав на редактирование)? Нужен ли отдельный признак «read_only_via_group»?
2. Требуется ли журналировать попытки доступа преподавателей к недоступным темам (для аудита)? Если да, где хранить логи.
3. Как обрабатывать сценарий, когда создатель темы удалён из системы: кто становится ответственным за тему и кто может назначить новых соавторов?
4. Нужно ли вводить ограничения на количество соавторов или контролировать дублирующие приглашения?
5. Каким образом фронтенд должен реагировать на новые флаги (`can_manage_topic`, `can_unlink_topic`, `read_only_via_group`) — скрывать действия или отображать подсказки?
6. Как проводить миграцию логики вопросов на банк вопросов, чтобы не потерять текущую стабильность (план поэтапного переноса, тестовое покрытие)?
7. Требуется ли синхронизировать новую модель доступа с кешем (Redis) и инвалидировать соответствующие ключи при изменении состава авторов?

## 7. Риски и дальнейшие шаги

- Нужна тщательная проверка существующих клиентов API (особенно legacy-ручек), чтобы не разорвать интеграции.
- Возможно потребуется миграция фронтенда (обновить схемы, ожидание авторов в ответах).
- После согласования вопросов — реализовать план:
  1. Уточнить требования и поведение для старых данных.
  2. Добавить схемы/сервисы/зависимости.
  3. Внедрить миграцию и обновить сервис создания.
  4. Пройтись по эндпоинтам и заменить `admin_or_teacher` на новую проверку (админ отдается флагом).
  5. Обновить тесты и документацию.



